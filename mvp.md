# 管理者画面付き・最小RAG構成（MVP）要件定義書

## 1. プロジェクト概要

### 1.1 目的
本番環境で運用可能な最小構成のRAG（Retrieval-Augmented Generation）システムを構築する。
管理者がナレッジベースを管理できる管理画面を備え、ユーザーがRAG機能を利用できる。

### 1.2 スコープ
- 管理者によるナレッジベースの追加・削除・一覧表示
- ユーザーによるRAG質問機能
- 認証・認可によるアクセス制御

### 1.3 開発期間
1〜2日で完成可能な規模

---

## 2. システムアーキテクチャ

### 2.1 全体構成

```
[ 管理者ブラウザ / ユーザーブラウザ ]
        ↓
[ Azure Static Web Apps ]
  /        → ユーザー用RAG画面
  /admin   → 管理者画面
        ↓
[ FastAPI ]
  ├─ POST   /chat              （RAG質問）
  ├─ GET    /admin/files       （一覧）
  ├─ POST   /admin/upload      （追加）
  └─ DELETE /admin/files/{id}   （削除）
        ↓
[ Supabase ]
  ├─ Auth (JWT)
  ├─ Storage
  └─ PostgreSQL + pgvector
        ↓
[ OpenAI API ]
```

### 2.2 技術スタック

| レイヤー | 技術 |
|---------|------|
| フロントエンド | HTML + Bootstrap（JSフレームワーク不要） |
| バックエンド | FastAPI |
| 認証 | Supabase Auth |
| データベース | Supabase PostgreSQL + pgvector |
| ストレージ | Supabase Storage |
| デプロイ | Azure Static Web Apps |
| AI | OpenAI API（Embedding + Chat） |

---

## 3. 機能要件

### 3.1 管理者機能

#### 3.1.1 管理者ログイン
- **機能**: Email/Passwordによる認証
- **認証方式**: Supabase Auth
- **認可**: `role: "admin"` のユーザーのみアクセス可能
- **画面**: `/admin/login`

#### 3.1.2 ナレッジ一覧表示
- **機能**: アップロード済みファイルの一覧を表示
- **表示項目**:
  - ファイル名
  - 登録日時
- **画面**: `/admin`
- **API**: `GET /admin/files`

#### 3.1.3 ナレッジ追加（Upload）
- **機能**: ファイルをアップロードし、自動的にRAG用データを生成
- **対応ファイル形式**: PDF / TXT / DOCX
- **自動処理フロー**:
  1. テキスト抽出
  2. チャンク分割
  3. Embedding生成（OpenAI API）
  4. pgvectorに保存
- **画面**: `/admin`（アップロードボタン）
- **API**: `POST /admin/upload`

#### 3.1.4 ナレッジ削除（Delete）
- **機能**: ファイル単位で削除
- **削除対象**:
  - ファイル本体
  - 対応するチャンクデータ
  - 対応するembeddingデータ
- **重要**: RAG事故を防ぐため、関連データの完全削除が必須
- **画面**: `/admin`（削除ボタン）
- **API**: `DELETE /admin/files/{id}`

### 3.2 ユーザー機能

#### 3.2.1 RAG質問
- **機能**: ナレッジベースを参照して質問に回答
- **処理フロー**:
  1. 質問文のEmbedding生成
  2. pgvectorで類似度検索
  3. 関連チャンクを取得
  4. OpenAI APIで回答生成
- **API**: `POST /chat`

---

## 4. 非機能要件

### 4.1 パフォーマンス
- フロントエンドは静的ファイルで超軽量
- APIは後から拡張可能な設計

### 4.2 セキュリティ
- 管理者機能は認証・認可必須
- JWTトークンによる認証
- ロールベースアクセス制御（RBAC）

### 4.3 保守性
- シンプルな構成で理解しやすい
- 機能を削りすぎず、実務で必要な最低限の管理機能を提供

---

## 5. API仕様

### 5.1 認証API

#### POST /auth/login
- **説明**: Supabase Authによるログイン
- **リクエスト**:
  ```json
  {
    "email": "string",
    "password": "string"
  }
  ```
- **レスポンス**:
  ```json
  {
    "access_token": "string",
    "user": {
      "id": "string",
      "email": "string",
      "role": "admin"
    }
  }
  ```

### 5.2 管理者API

#### GET /admin/files
- **説明**: アップロード済みファイル一覧取得
- **認証**: 必須（管理者のみ）
- **レスポンス**:
  ```json
  [
    {
      "id": "string",
      "filename": "string",
      "created_at": "2024-01-01T00:00:00Z"
    }
  ]
  ```

#### POST /admin/upload
- **説明**: ファイルアップロード
- **認証**: 必須（管理者のみ）
- **リクエスト**: `multipart/form-data`
  - `file`: ファイル（PDF/TXT/DOCX）
- **レスポンス**:
  ```json
  {
    "id": "string",
    "filename": "string",
    "status": "success"
  }
  ```

#### DELETE /admin/files/{id}
- **説明**: ファイル削除（チャンク・embeddingも同時削除）
- **認証**: 必須（管理者のみ）
- **パラメータ**: `id` (path parameter)
- **レスポンス**:
  ```json
  {
    "status": "deleted",
    "id": "string"
  }
  ```

### 5.3 ユーザーAPI

#### POST /chat
- **説明**: RAG質問
- **認証**: 不要（または任意）
- **リクエスト**:
  ```json
  {
    "question": "string"
  }
  ```
- **レスポンス**:
  ```json
  {
    "answer": "string",
    "sources": [
      {
        "file_id": "string",
        "chunk_id": "string",
        "content": "string"
      }
    ]
  }
  ```

---

## 6. データベース設計

### 6.1 テーブル定義

#### files テーブル
| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | ファイルID |
| filename | VARCHAR | NOT NULL | ファイル名 |
| created_at | TIMESTAMP | NOT NULL DEFAULT NOW() | 登録日時 |

#### chunks テーブル
| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | チャンクID |
| file_id | UUID | FOREIGN KEY → files.id | ファイルID |
| content | TEXT | NOT NULL | チャンク内容 |
| embedding | vector(1536) | NOT NULL | Embeddingベクトル（pgvector） |

### 6.2 インデックス
- `chunks.embedding`: ベクトル類似度検索用インデックス（pgvector）
- `chunks.file_id`: ファイル削除時の効率的な検索用

---

## 7. 画面設計

### 7.1 管理者画面

#### 7.1.1 ログイン画面 (`/admin/login`)
```
┌─────────────────────────┐
│   管理者ログイン         │
├─────────────────────────┤
│ Email: [____________]   │
│                         │
│ Password: [_________]   │
│                         │
│    [ Login ]            │
└─────────────────────────┘
```

#### 7.1.2 管理画面 (`/admin`)
```
┌─────────────────────────────────────┐
│   ナレッジ管理                       │
├─────────────────────────────────────┤
│ [ アップロード ]                     │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ ファイル名    │ 登録日時        │ │
│ ├─────────────────────────────────┤ │
│ │ document.pdf │ 2024-01-01 10:00│ │
│ │              │ [削除]          │ │
│ ├─────────────────────────────────┤ │
│ │ report.txt   │ 2024-01-02 14:30│ │
│ │              │ [削除]          │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 7.2 ユーザー画面

#### 7.2.1 RAG質問画面 (`/`)
```
┌─────────────────────────────────────┐
│   RAG質問                            │
├─────────────────────────────────────┤
│ 質問: [___________________________] │
│                                     │
│      [ 送信 ]                       │
│                                     │
│ 回答:                               │
│ ┌─────────────────────────────────┐ │
│ │                                 │ │
│ │                                 │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 7.3 UI要件
- Bootstrapを使用（JSフレームワーク不要）
- レスポンシブデザイン対応
- シンプルで直感的なUI

---

## 8. 認証・認可設計

### 8.1 認証方式
- **プロバイダ**: Supabase Auth
- **方式**: Email/Password認証
- **トークン**: JWT（JSON Web Token）

### 8.2 認可方式
- **ロール管理**: Supabase users metadata
  ```json
  {
    "role": "admin"
  }
  ```
- **認可チェック**: FastAPI側で実装
  ```python
  if user.role != "admin":
      raise HTTPException(status_code=403)
  ```

### 8.3 アクセス制御
- `/admin/*`: 管理者のみアクセス可能
- `/chat`: 認証不要（または任意）

---

## 9. 実装優先順位

### Phase 1: 基盤構築
1. Supabaseプロジェクト作成・設定
2. データベーステーブル作成
3. FastAPIプロジェクト作成
4. 認証機能実装

### Phase 2: 管理者機能
1. ログイン画面実装
2. ファイル一覧表示機能
3. ファイルアップロード機能
4. ファイル削除機能

### Phase 3: RAG機能
1. テキスト抽出・チャンク分割実装
2. Embedding生成・保存実装
3. 類似度検索実装
4. 質問回答機能実装

### Phase 4: デプロイ
1. Azure Static Web Apps設定
2. 本番環境デプロイ
3. 動作確認

---

## 10. MVP完成条件

以下の条件をすべて満たすことをMVP完成とする：

- [ ] 管理者ログインできる
- [ ] ナレッジ追加できる（PDF/TXT/DOCX対応）
- [ ] ナレッジ削除できる
- [ ] 削除時にチャンク・embeddingも同時に削除される
- [ ] ユーザー画面でRAG質問ができる
- [ ] ナレッジ追加・削除がユーザー画面に即反映される

---

## 11. まとめ

本要件定義は、「アップロード・削除だけできる管理画面を持った、本番前提の最小RAG」を実現するための設計書である。

機能を削りすぎず、実務で最低限必要な管理機能を提供し、シンプルで拡張可能な構成を目指す。
