# Supabase Row Level Security (RLS) 設定ガイド

## 問題

ファイルアップロード時に以下のエラーが発生する場合：

```
new row violates row-level security policy
```

これは、SupabaseのRow Level Security (RLS) が有効になっているが、適切なポリシーが設定されていないために発生します。

## 解決方法

### 方法1: RLSポリシーを設定する（推奨）

1. Supabaseダッシュボードの「SQL Editor」を開く
2. `docs/setup_rls.sql`の内容をコピー＆ペースト
3. 「Run」ボタンをクリックして実行

これで、認証済みユーザーが`files`と`chunks`テーブルにアクセスできるようになります。

### 方法2: サービスロールキーを使用する（現在の実装）

現在のコードは、データベースへの書き込み操作にサービスロールキーを使用しています。
サービスロールキーはRLSをバイパスするため、ポリシー設定なしでも動作します。

**注意**: サービスロールキーは秘密鍵です。フロントエンドで使用しないでください。

## 確認事項

- [ ] `backend/.env`に`SUPABASE_SERVICE_KEY`が設定されている
- [ ] RLSポリシーが設定されている（方法1を選択した場合）
- [ ] ファイルアップロードが成功する

## トラブルシューティング

### まだエラーが発生する場合

1. SupabaseダッシュボードでテーブルのRLS設定を確認
   - 「Table Editor」→ テーブルを選択 → 「RLS」タブ
   - RLSが有効になっているか確認

2. サービスロールキーが正しく設定されているか確認
   - `backend/.env`ファイルを確認
   - Supabaseダッシュボードの「Settings」→「API」から確認

3. サーバーのログを確認
   - エラーの詳細を確認
   - スタックトレースを確認

